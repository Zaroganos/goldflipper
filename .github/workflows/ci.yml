name: CI

on:
  push:
    branches: [ "main", "multistrat" ]
  pull_request:
    branches: [ "main", "multistrat" ]

jobs:
  check:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Create test settings.yaml for CI
        run: |
          $testSettings = @"
          # Minimal test configuration for CI environment
          alpaca:
            accounts:
              paper_1:
                enabled: true
                nickname: "CI Test Paper 1"
                api_key: 'TEST_API_KEY'
                secret_key: 'TEST_SECRET_KEY'
                base_url: 'https://paper-api.alpaca.markets/v2'
            default_account: 'paper_1'
            active_account: 'paper_1'
          
          strategy_orchestration:
            enabled: true
            mode: "sequential"
            max_parallel_workers: 3
            dry_run: true
          
          options_swings:
            enabled: true
            entry_order_types: ["market"]
            TP-SL_types: ["STOCK_PRICE"]
            Take_Profit:
              multiple_TPs: false
            SL_order_types: ["STOP"]
            conditional_plays:
              enabled: false
            play_types: ["SIMPLE"]
          
          market_data_providers:
            primary_provider: "yfinance"
            providers:
              yfinance:
                enabled: true
                cache:
                  enabled: true
                  max_age: 300
              alpaca:
                enabled: false
              marketdataapp:
                enabled: false
            cache:
              enabled: true
              max_items: 1000
          
          logging:
            level: "ERROR"
            format: "%(asctime)s - %(levelname)s - %(message)s"
          "@
          $testSettings | Out-File -FilePath "goldflipper/config/settings.yaml" -Encoding utf8

      - name: Lint with Ruff
        run: uv run ruff check .

      - name: Check formatting with Ruff
        run: uv run ruff format --check .

      - name: Type check with Pyright
        run: uv run pyright

      - name: Run tests with pytest
        run: uv run pytest
